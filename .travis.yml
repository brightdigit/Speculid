language: objective-c
env:
  global:
  - secure: hVl7EFbdJhUsIzMXOZ0BESzmcMwro5fSHoFD33xCoWF+4Ov5TtiW5iy02Z4096fbgziD5SBdNG/4y87Z0kqRPPJgcGOObfwE3VWkIYj6dIHaXXnGlmieTEMRkq4a4GOjXJFpJODkKPmMSL1NLqdxUYFmn3rvCyBEQjiRQzygTj4=
branches:
  except:
  - develop
osx_image: xcode9.2
xcode_workspace: speculid.xcworkspace
xcode_scheme: Speculid-Mac-App
before_install:
- brew update
- brew install librsvg cairo
- pod repo update
- pod install
script:
- "./decrypt-certs.sh"
- "./build-keychain.sh"
- "./setup-dependencies.sh"
- xcodebuild archive -workspace speculid.xcworkspace -scheme "Speculid-Mac-App" -configuration
  Release -derivedDataPath ./build -archivePath ./build/Products/Speculid.xcarchive
- xcodebuild -exportArchive -archivePath ./build/Products/Speculid.xcarchive -exportOptionsPlist
  ./exportOptions.plist -exportPath ./build/Products/App
- ditto -c -k --sequesterRsrc --keepParent ./build/Products/App/Speculid.app build/Speculid.zip
- brew remove --ignore-dependencies --force librsvg cairo
- open Build/Products/App/Speculid.app
- osascript -e 'tell application "Speculid" to quit'
- diff examples/shasum <(./shasum.sh)
before_deploy:
- git config --global user.email "builds@travis-ci.com"
- git config --global user.name "Travis CI"
- export GIT_TAG=v`./bin/package.sh ./build/Products/App/Speculid.app`.$TRAVIS_BUILD_NUMBER-dev
- git tag $GIT_TAG -a -m "Generated tag from TravisCI for build $TRAVIS_BUILD_NUMBER"
- git push -q https://${TRAVIS_SECURE_TOKEN_NAME}@github.com/brightdigit/speculid --tags
deploy:
  provider: releases
  prerelease: true
  api_key:
    secure: kB1IJxdHO6n3vTU6qR4klgASWhMzZmiiKYuKppgjZ5zq/dwTma8Ls3PabZcCoo8Bb+tZVXrohLweKwqP+IjH+oydV+9qt4oh2Q6po6gS+Qj3bTMQ+KrZYc699p32JVASQsRgLkYSUQHFT1wR4R5tlGw3A+tevJFlG56tC2WV1Sw=
  file: "build/Speculid.zip"
  skip_cleanup: true
  on:
    tags: false
    all_branches: true
after_failure:
- "./shasum.sh"
- find "examples/Assets/." -type f \( -iname \*.icns -o -iname \*.png -o -iname \*.pdf
  \) -print0 | sort -z | xargs -0 shasum -a 512
notifications:
  webhooks:
    urls:
    - https://webhooks.gitter.im/e/f596466e5c30701b566d
    on_success: change
    on_failure: always
    on_start: never
